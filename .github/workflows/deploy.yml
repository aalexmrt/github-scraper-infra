name: Deploy

on:
  # Option 1: Manual trigger via GitHub UI
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy (api, commit-worker, user-worker)'
        required: true
        type: choice
        options:
          - api
          - commit-worker
          - user-worker
      version:
        description: 'Version to deploy (e.g., 1.2.3)'
        required: true

  # Option 2: Automated trigger from main repo (via repository_dispatch)
  repository_dispatch:
    types: [deploy]

  # Option 3: Trigger on tag push (if tags are pushed to infra repo)
  # Note: Usually tags are in main repo, but this allows flexibility
  push:
    tags:
      - 'api-v*.*.*'
      - 'commit-worker-v*.*.*'
      - 'user-worker-v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v3

      - name: Extract service and version
        id: extract
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger: Get from inputs
            SERVICE="${{ github.event.inputs.service }}"
            VERSION="${{ github.event.inputs.version }}"
            # If api is deployed manually, deploy all services
            if [ "$SERVICE" = "api" ]; then
              echo "DEPLOY_ALL=true" >> $GITHUB_OUTPUT
            else
              echo "DEPLOY_ALL=false" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            # Automated trigger: Get from payload
            SERVICE="${{ github.event.client_payload.service }}"
            VERSION="${{ github.event.client_payload.version }}"
            # Main repo builds all services when api tag is pushed
            # It sends separate dispatch events for each service
            # So we deploy only the specific service requested
            echo "DEPLOY_ALL=false" >> $GITHUB_OUTPUT
          else
            # Tag push: Extract from tag (api-v1.2.3)
            TAG=${GITHUB_REF#refs/tags/}
            if [[ $TAG =~ ^(.+)-v(.+)$ ]]; then
              SERVICE="${BASH_REMATCH[1]}"
              VERSION="${BASH_REMATCH[2]}"
              # If api tag is pushed, deploy all services
              if [ "$SERVICE" = "api" ]; then
                echo "DEPLOY_ALL=true" >> $GITHUB_OUTPUT
              else
                echo "DEPLOY_ALL=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âŒ Error: Invalid tag format"
              exit 1
            fi
          fi
          echo "SERVICE=${SERVICE}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Verify images exist
        run: |
          REGION=${{ secrets.GCP_REGION }}
          PROJECT_ID=${{ secrets.PROJECT_ID }}
          REPOSITORY=github-scraper
          SERVICE=${{ steps.extract.outputs.SERVICE }}
          VERSION=${{ steps.extract.outputs.VERSION }}
          DEPLOY_ALL=${{ steps.extract.outputs.DEPLOY_ALL }}
          
          # Determine which services to verify
          if [ "$DEPLOY_ALL" = "true" ]; then
            SERVICES=("api" "commit-worker" "user-worker")
            echo "ğŸ” Verifying all service images (api, commit-worker, user-worker)..."
          else
            SERVICES=("${SERVICE}")
            echo "ğŸ” Verifying ${SERVICE} image..."
          fi
          
          # Verify each service image exists
          for SVC in "${SERVICES[@]}"; do
            if ! gcloud artifacts docker images describe \
              ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SVC}:${VERSION} \
              --project=${PROJECT_ID} &>/dev/null; then
              echo "âŒ Error: Image ${SVC}:${VERSION} not found in registry"
              echo "   Build it first in github-scraper repo:"
              echo "   git tag ${SVC}-v${VERSION} && git push origin ${SVC}-v${VERSION}"
              exit 1
            fi
            echo "âœ… Found ${SVC}:${VERSION}"
          done

      - name: Deploy services
        run: |
          export PROJECT_ID=${{ secrets.PROJECT_ID }}
          export REGION=${{ secrets.GCP_REGION }}
          SERVICE=${{ steps.extract.outputs.SERVICE }}
          VERSION=${{ steps.extract.outputs.VERSION }}
          DEPLOY_ALL=${{ steps.extract.outputs.DEPLOY_ALL }}
          
          # Determine which services to deploy
          if [ "$DEPLOY_ALL" = "true" ]; then
            SERVICES=("api" "commit-worker" "user-worker")
            echo "ğŸš€ Deploying all services (api, commit-worker, user-worker) with version ${VERSION}..."
          else
            SERVICES=("${SERVICE}")
            echo "ğŸš€ Deploying ${SERVICE} with version ${VERSION}..."
          fi
          
          # Deploy each service
          for SVC in "${SERVICES[@]}"; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ“¦ Deploying ${SVC}:${VERSION}"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            ./scripts/deploy/deploy.sh ${SVC} ${VERSION}
          done
          
          echo ""
          echo "âœ… All deployments completed successfully"

      # Note: Health checks are implemented in deploy.sh script
      # For API service, it checks /health endpoint after deployment
      # For workers, health checks aren't applicable (they run on schedule)

